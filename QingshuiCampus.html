<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>充电桩地图查询</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #3B82F6; /* blue-500 */
            --color-text-base: #374151; /* gray-700 */
            --color-bg-base: #F9FAFB; /* gray-50 */
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-base);
        }
        .leaflet-div-icon { background: transparent; border: none; }
        
        .map-marker {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .leaflet-marker-icon:hover .map-marker {
            transform: scale(1.25);
        }
        
        #station-detail-panel {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.6);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .nav-button.active {
            background-color: var(--color-primary);
            color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .leaflet-tooltip.station-tooltip {
            background-color: rgba(26, 32, 44, 0.85);
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .leaflet-tooltip-top.station-tooltip:before,
        .leaflet-tooltip-bottom.station-tooltip:before,
        .leaflet-tooltip-left.station-tooltip:before,
        .leaflet-tooltip-right.station-tooltip:before {
            border: none;
        }
        input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
            border-color: var(--color-primary);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col h-screen">

    <header class="bg-white/80 backdrop-blur-sm shadow-sm z-[1100] border-b border-gray-200"><nav class="container mx-auto px-4 py-3 flex justify-between items-center"><h1 class="text-xl font-bold text-gray-900">EndlessPower</p>成电清水河充电桩查询</h1><div class="flex space-x-1 bg-gray-200/80 p-1 rounded-lg"><button id="nav-map" class="nav-button px-4 py-1.5 rounded-md text-sm font-semibold transition-all">地图</button><button id="nav-favorites" class="nav-button px-4 py-1.5 rounded-md text-sm font-semibold transition-all">收藏</button></div></nav></header>
    
    <main class="flex-grow relative">
        <div id="map-page" class="page-content w-full h-full">
            <div id="search-container" class="absolute top-4 left-1/2 -translate-x-1/2 z-[1000] w-full max-w-sm px-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg></div>
                    <input type="text" id="search-input" placeholder="搜索充电站..." class="w-full h-12 pl-12 pr-24 rounded-full border-gray-200 shadow-lg focus:ring-2 focus:ring-blue-400 focus:border-transparent outline-none transition">
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <button id="clear-search-btn" class="hidden h-full px-3 text-gray-400 hover:text-gray-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                        <button id="search-btn" class="h-full px-4 text-gray-500 hover:text-blue-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg></button>
                    </div>
                </div>
            </div>
            <div id="map" class="w-full h-full"></div>
            <button id="refresh-btn" class="absolute bottom-6 right-6 z-[999] bg-white text-gray-700 p-3 rounded-full shadow-lg hover:bg-gray-100 hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5m7 0h-5V4m0 0l7 7m-7-7H4" /><path stroke-linecap="round" stroke-linejoin="round" d="M20 20v-5h-5m-7 0h5v5m0 0l-7-7m7 7h5" /></svg>
            </button>
            <button id="locate-btn" class="absolute bottom-6 right-24 z-[999] bg-white text-gray-700 p-3 rounded-full shadow-lg hover:bg-gray-100 hover:scale-105 active:scale-95 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <div id="map-loader" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[999] bg-white/80 p-4 rounded-lg shadow-xl flex items-center space-x-3"><div class="loader"></div><span class="font-semibold text-gray-700">刷新状态...</span></div>
        </div>
        <div id="favorites-page" class="page-content hidden w-full h-full overflow-y-auto p-4 md:p-6">
            <div class="container mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">我的收藏</h2>
                    <button id="refresh-favorites-btn" class="bg-white text-gray-700 p-3 rounded-full shadow-md hover:bg-gray-100 hover:scale-105 active:scale-95 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5m7 0h-5V4m0 0l7 7m-7-7H4" /><path stroke-linecap="round" stroke-linejoin="round" d="M20 20v-5h-5m-7 0h5v5m0 0l-7-7m7 7h5" /></svg>
                    </button>
                </div>
                <div id="favorites-container" class="space-y-6"></div>
            </div>
        </div>
    </main>

    <footer class="text-center py-4 text-xs text-gray-500 bg-white border-t border-gray-200 z-10 shrink-0">
        <div class="space-y-2">
            <div id="visitor-stats" class="inline-block"></div>
            <p>
                <a href="https://github.com/jasonmumiao/EndlessPower" target="_blank" rel="noopener noreferrer" class="inline-flex items-center hover:text-gray-800 transition-colors">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd"></path></svg>
                    View Project on GitHub
                </a>
            </p>
        </div>
    </footer>

    <div id="station-detail-panel" class="fixed bottom-4 right-4 w-full max-w-md rounded-xl transform translate-y-full opacity-0 pointer-events-none z-[1200]">
        <div class="p-5 border-b border-gray-200/80">
            <div class="flex justify-between items-center">
                <div class="flex-1 min-w-0">
                    <h2 id="detail-station-name" class="text-lg font-bold text-gray-800 truncate"></h2>
                    <p id="detail-station-address" class="text-sm text-gray-500 truncate"></p>
                </div>
                <div class="flex items-center space-x-1 ml-4">
                    <button id="detail-favorite-btn" class="text-gray-400 hover:text-yellow-500 p-2 rounded-full hover:bg-yellow-100 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg></button>
                    <button id="detail-close-btn" class="text-gray-500 hover:text-gray-800 p-2 rounded-full hover:bg-gray-200/80 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </div>
        </div>
        <div id="detail-outlets-grid" class="p-5 h-72 overflow-y-auto grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    </div>
    
    <div id="error-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[2000] flex justify-center items-center p-4"><div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm"><h3 class="text-lg font-bold text-red-600 mb-2">出错了！</h3><p id="error-message" class="text-gray-700"></p><button id="error-close-btn" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">关闭</button></div></div>
    
    <template id="station-card-template"><div class="station-card bg-white rounded-xl shadow-md overflow-hidden transition-shadow hover:shadow-lg"><div class="p-5"><div class="flex justify-between items-start mb-4"><div class="min-w-0 flex-1"><h2 class="station-name text-xl font-bold text-gray-800 truncate"></h2><p class="station-address text-sm text-gray-500 mt-1 truncate"></p></div><button class="remove-favorite-btn text-gray-400 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors ml-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div><div class="station-summary grid grid-cols-3 gap-2 text-center text-sm text-gray-600 mb-4 p-3 bg-gray-50 rounded-lg"><div><p class="font-semibold text-lg text-gray-800 total-outlets">?</p><p class="text-xs">总插座</p></div><div><p class="font-semibold text-lg text-green-600 available-outlets">?</p><p class="text-xs">可用</p></div><div><p class="font-semibold text-lg text-blue-600 occupied-outlets">?</p><p class="text-xs">占用</p></div></div><div class="outlets-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div></div></div></template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 配置 ---
        const MAP_CENTER = [30.754365, 103.936107];
        const REFRESH_COOLDOWN = 15000; // 15 seconds
        const FAVORITE_LIMIT=4;
        const JITTER_AMOUNT = 0.0004;

        let map, markers = {}, currentDetailRequestId = 0;
        let lastMapRefresh = 0, lastFavoritesRefresh = 0;
        let userLocationMarker; // 用户位置标记

        // --- DOM 元素 ---
        const navButtons = { map: document.getElementById('nav-map'), favorites: document.getElementById('nav-favorites') };
        const pages = { map: document.getElementById('map-page'), favorites: document.getElementById('favorites-page') };
        const detailPanel = document.getElementById('station-detail-panel');
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshFavoritesBtn = document.getElementById('refresh-favorites-btn');
        const locateBtn = document.getElementById('locate-btn');
        const mapLoader = document.getElementById('map-loader');
        const errorOverlay = document.getElementById('error-overlay');
        const errorMessage = document.getElementById('error-message');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const StationDB = { get: () => JSON.parse(localStorage.getItem('managedStations') || 'null'), set: (stations) => localStorage.setItem('managedStations', JSON.stringify(stations)) };
        const FavoritesManager = { 
            get: () => JSON.parse(localStorage.getItem('favoriteStations') || '[]'), 
            set: (favorites) => localStorage.setItem('favoriteStations', JSON.stringify(favorites)), 
            add: (stationId) => {
                const favs = FavoritesManager.get();
                if (favs.includes(stationId)) return;
                if (favs.length >= FAVORITE_LIMIT) {
                    showError('收藏夹已满，请先移除一些站点。');
                    return;
                }
                favs.push(stationId);
                FavoritesManager.set(favs);
            },
            remove: (stationId) => FavoritesManager.set(FavoritesManager.get().filter(id => id !== stationId)), 
            isFavorite: (stationId) => FavoritesManager.get().includes(stationId) 
        };
        
        async function initApp() {
            initMaps();
            navButtons.map.addEventListener('click', () => switchView('map'));
            navButtons.favorites.addEventListener('click', () => switchView('favorites'));
            refreshBtn.addEventListener('click', handleMapRefresh);
            locateBtn.addEventListener('click', getCurrentLocation);
            refreshFavoritesBtn.addEventListener('click', handleFavoritesRefresh);
            document.getElementById('error-close-btn').addEventListener('click', () => errorOverlay.classList.add('hidden'));
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') performSearch(); });
            searchInput.addEventListener('input', () => clearSearchBtn.classList.toggle('hidden', !searchInput.value));
            clearSearchBtn.addEventListener('click', clearSearch);

            // 尝试获取用户当前位置，如果失败则使用默认位置
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        // 更新地图中心到用户位置
                        map.setView([latitude, longitude], 16);
                        // 显示用户位置标记
                        userLocationMarker.setLatLng([latitude, longitude]);
                        userLocationMarker.setOpacity(1);
                        // 获取并显示该位置附近的充电站
                        await initialFetchAndStoreStations(latitude, longitude);
                        switchView('map');
                    },
                    async (error) => {
                        // 如果获取位置失败，使用默认位置
                        const localStations = StationDB.get();
                        if (!localStations || localStations.length === 0) await initialFetchAndStoreStations();
                        switchView('map');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                // 浏览器不支持地理位置功能，使用默认位置
                const localStations = StationDB.get();
                if (!localStations || localStations.length === 0) await initialFetchAndStoreStations();
                switchView('map');
            }
        }

        // 添加获取用户当前位置的函数
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                showError('您的浏览器不支持地理位置功能');
                return;
            }

            // 显示加载状态
            mapLoader.classList.remove('hidden');
            locateBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                // 成功回调
                async (position) => {
                    const { latitude, longitude } = position.coords;

                    // 更新地图中心到用户位置
                    map.setView([latitude, longitude], 16);

                    // 显示用户位置标记
                    userLocationMarker.setLatLng([latitude, longitude]);
                    userLocationMarker.setOpacity(1);

                    // 重新获取并显示该位置附近的充电站
                    await fetchAndRenderStations(latitude, longitude);

                    // 恢复按钮状态
                    mapLoader.classList.add('hidden');
                    locateBtn.disabled = false;
                },
                // 错误回调
                (error) => {
                    mapLoader.classList.add('hidden');
                    locateBtn.disabled = false;

                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            showError('用户拒绝了地理位置请求');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            showError('位置信息不可用');
                            break;
                        case error.TIMEOUT:
                            showError('获取位置信息超时');
                            break;
                        default:
                            showError('获取地理位置时发生未知错误');
                            break;
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // 修改获取充电站数据的函数，支持传入位置参数
        async function fetchAndRenderStations(lat = 30.754736739439924, lng = 103.92946279311207) {
            mapLoader.classList.remove('hidden');

            // 更新API调用参数
            const nearStations = await fetchNearStationsAPI(lat, lng);

            if (nearStations && nearStations.length > 0) {
                StationDB.set(applyJitter(nearStations));
                renderMarkers();
            }

            mapLoader.classList.add('hidden');
        }

        function switchView(view) {
            hideStationDetailPanel(); 
            document.body.classList.toggle('overflow-hidden', view === 'map');
            for (const key in pages) pages[key].classList.toggle('hidden', key !== view);
            for (const key in navButtons) navButtons[key].classList.remove('active'); 
            navButtons[view].classList.add('active'); 
            if (view === 'map') {
                if (map) map.invalidateSize(); 
                clearSearch();
            } else if (view === 'favorites') {
                renderFavoritesPage(); 
            } 
        }

        function handleMapRefresh() {
            const now = Date.now();
            if (now - lastMapRefresh < REFRESH_COOLDOWN) return;
            lastMapRefresh = now;
            refreshMarkersStatus();
            refreshBtn.disabled = true;
            setTimeout(() => { refreshBtn.disabled = false; }, REFRESH_COOLDOWN);
        }

        function handleFavoritesRefresh() {
            const now = Date.now();
            if (now - lastFavoritesRefresh < REFRESH_COOLDOWN) return;
            lastFavoritesRefresh = now;
            renderFavoritesPage();
            refreshFavoritesBtn.disabled = true;
            setTimeout(() => { refreshFavoritesBtn.disabled = false; }, REFRESH_COOLDOWN);
        }

        async function initialFetchAndStoreStations(lat, lng) {
            mapLoader.classList.remove('hidden');
            const nearStations = await fetchNearStationsAPI(lat, lng);
            if (nearStations && nearStations.length > 0) StationDB.set(applyJitter(nearStations));
            mapLoader.classList.add('hidden');
        }
        function renderMarkers(filterKeyword = '') { const stations = StationDB.get() || []; if (!stations) return; const lowerCaseKeyword = filterKeyword.trim().toLowerCase(); const filteredStations = lowerCaseKeyword ? stations.filter(s => s.stationName.toLowerCase().includes(lowerCaseKeyword)) : stations; for (const key in markers) if (map.hasLayer(markers[key])) map.removeLayer(markers[key]); markers = {}; filteredStations.forEach(station => { const icon = createMarkerIcon('#9ca3af'); const marker = L.marker([station.latitude, station.longitude], { icon }).addTo(map); marker.bindTooltip(station.stationName, { permanent: false, direction: 'top', offset: [0, -12], className: 'station-tooltip' }); marker.on('click', () => showStationDetailPanel(station)); markers[station.stationId] = marker; }); refreshMarkersStatus(); }
        async function refreshMarkersStatus() { mapLoader.classList.remove('hidden'); const dynamicData = await fetchNearStationsAPI(); if (dynamicData) { const statusMap = new Map(dynamicData.map(s => [s.stationId, {freeNum: s.freeNum, switchType: s.switchType}])); for (const stationId in markers) { if (map.hasLayer(markers[stationId])) { const status = statusMap.get(parseInt(stationId, 10)); const marker = markers[stationId]; const ratio = status && status.switchType > 0 ? status.freeNum / status.switchType : -1; marker.setIcon(createMarkerIcon(getColorForAvailability(ratio))); } } } mapLoader.classList.add('hidden'); }
        function performSearch() { hideStationDetailPanel(); renderMarkers(searchInput.value); }
        function clearSearch() { searchInput.value = ''; clearSearchBtn.classList.add('hidden'); hideStationDetailPanel(); renderMarkers(); }
        function applyJitter(stations) { const newStations = []; const occupiedCoords = new Set(); const distanceSq = (p1, p2) => (p1.lat - p2.lat)**2 + (p1.lng - p2.lng)**2; const minDistanceSq = (0.0003)**2; stations.forEach(station => { let newLat = station.latitude, newLng = station.longitude; let attempts = 0; while (attempts < 100) { let collision = false; for (const coord of occupiedCoords) { if (distanceSq({lat: newLat, lng: newLng}, JSON.parse(coord)) < minDistanceSq) { collision = true; newLat += (Math.random() - 0.5) * JITTER_AMOUNT; newLng += (Math.random() - 0.5) * JITTER_AMOUNT; break; } } if (!collision) break; attempts++; } occupiedCoords.add(JSON.stringify({lat: newLat, lng: newLng})); newStations.push({ ...station, latitude: newLat, longitude: newLng }); }); return newStations; }
        function createMarkerIcon(color) { return L.divIcon({ className: 'leaflet-div-icon', html: `<div class="map-marker" style="background-color: ${color};"></div>`, iconSize: [20, 20], iconAnchor: [10, 10] }); }
        function initMaps() {
            map = L.map('map', { zoomControl: false }).setView(MAP_CENTER, 16);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            L.tileLayer('https://wprd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}', {
                subdomains: ['1', '2', '3', '4'],
                attribution: '&copy; 高德地图'
            }).addTo(map);

            // 添加用户位置标记
            userLocationMarker = L.marker([0, 0], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background-color: #3B82F6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3);"></div>',
                    iconSize: [22, 22],
                    iconAnchor: [11, 11]
                })
            }).addTo(map);
            userLocationMarker.setOpacity(0); // 初始隐藏
        }
        
        // ✨ 2. 修复了CORS跨域问题，不再需要浏览器插件 ✨
        async function fetchAPI(url, options = {}) {
            try {
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
                const response = await fetch(proxyUrl, options);
                if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
                const data = await response.json();
                if (data.code !== "1") throw new Error(data.msg || 'API error');
                return data.data;
            } catch (error) {
                console.error(`Fetch error for ${url}:`, error);
                showError(`数据加载失败: ${error.message}。`);
                return null;
            }
        }
        
        const getOutlets = (stationId) => fetchAPI(`https://wemp.issks.com/charge/v1/outlet/station/outlets/${stationId}`);
        const getOutletStatus = (outletNo) => fetchAPI(`https://wemp.issks.com/charge/v1/charging/outlet/${outletNo}`);
        const fetchNearStationsAPI = (lat = 30.754736739439924, lng = 103.92946279311207) => {
            const url = 'https://wemp.issks.com/device/v1/near/station';
            const body = {
                page: 1,
                pageSize: 200,
                scale: 3,
                latitude: lat,
                longitude: lng,
                userLatitude: lat,
                userLongitude: lng
            };
            return fetchAPI(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=UTF-8' },
                body: JSON.stringify(body)
            })
                .then(data => data?.elecStationData || []);
        };
        
        function hideStationDetailPanel(){ detailPanel.classList.add('translate-y-full', 'opacity-0', 'pointer-events-none'); }
        
        function showStationDetailPanel(station) {
            currentDetailRequestId++;
            const thisRequestId = currentDetailRequestId;
            document.getElementById('detail-station-name').textContent = station.stationName;
            document.getElementById('detail-station-address').textContent = station.address;
            const favBtn = document.getElementById('detail-favorite-btn');
            const updateFavBtnStyle = () => favBtn.classList.toggle('text-yellow-400', FavoritesManager.isFavorite(station.stationId));
            updateFavBtnStyle();

            // ✨ 3. 修正了收藏按钮的添加/移除逻辑 ✨
            favBtn.onclick = () => {
                if (FavoritesManager.isFavorite(station.stationId)) {
                    FavoritesManager.remove(station.stationId);
                } else {
                    FavoritesManager.add(station.stationId);
                }
                updateFavBtnStyle();
            };

            document.getElementById('detail-close-btn').onclick = hideStationDetailPanel;
            const outletsGrid = document.getElementById('detail-outlets-grid');
            outletsGrid.innerHTML = '<div class="col-span-full flex justify-center p-8"><div class="loader"></div></div>';
            detailPanel.classList.remove('translate-y-full', 'opacity-0', 'pointer-events-none');
            updateOutletsInContainer(station.stationId, outletsGrid, thisRequestId);
        }

        function buildOutletCardHTML(statusData) {
            if (!statusData || !statusData.outlet) {
                return `<div class="bg-gray-100 rounded-xl p-4 border border-gray-200"><h3 class="text-base font-semibold text-gray-500">插座 N/A</h3><p class="text-sm text-red-500 mt-2">数据加载失败</p></div>`;
            }
            const isAvailable = statusData.outlet.iCurrentChargingRecordId === 0;
            const serial = `插座 ${statusData.outlet.vOutletName.replace('插座','') || 'N/A'}`;
            let statusHTML, detailsHTML, cardClasses;
            if (isAvailable) {
                cardClasses = 'bg-green-50/80 border-green-200';
                statusHTML = `<span class="text-xs font-bold py-1 px-2.5 rounded-full bg-green-100 text-green-800">可用</span>`;
                detailsHTML = `<div class="mt-3 text-center"><p class="font-semibold text-green-700">空闲中</p></div>`;
            } else {
                cardClasses = 'bg-blue-50/80 border-blue-200';
                statusHTML = `<span class="text-xs font-bold py-1 px-2.5 rounded-full bg-blue-100 text-blue-800">占用中</span>`;
                detailsHTML = `<div class="mt-2 text-sm space-y-1.5 text-gray-600">
                    <p><strong>已充:</strong> ${statusData.usedmin || 0}分钟</p>
                    <p><strong>消费:</strong> ${statusData.usedfee?.toFixed(2) || '0.00'}元</p>
                    <p><strong>功率:</strong> ${statusData.powerFee?.billingPower || '未知'}</p>
                    <p class="text-xs truncate pt-1"><strong>开始:</strong> ${statusData.chargingBeginTime || '未知'}</p>
                </div>`;
            }
            return `<div class="outlet-card rounded-xl p-4 border transition-all ${cardClasses}"><div class="flex justify-between items-center"><h3 class="text-base font-semibold text-gray-800">${serial}</h3>${statusHTML}</div>${detailsHTML}</div>`;
        }

        async function updateOutletsInContainer(stationId, container, requestId) {
            const outlets = await getOutlets(stationId);
            if (requestId !== currentDetailRequestId) return;
            if (!outlets || outlets.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-4">该充电站暂无插座信息。</p>`;
                return;
            }
            const statuses = await Promise.all(outlets.map(o => getOutletStatus(o.outletNo)));
            if (requestId !== currentDetailRequestId) return;
            const outletsHTML = outlets
                .sort((a, b) => a.outletSerialNo - b.outletSerialNo)
                .map((outlet, i) => buildOutletCardHTML(statuses[i]))
                .join('');
            container.innerHTML = outletsHTML;
        }

        async function updateFavoriteStationCard(stationId, cardElement) {
            const container = cardElement.querySelector('.outlets-grid');
            if (!container) return;
            container.innerHTML = '<div class="col-span-full flex justify-center p-8"><div class="loader"></div></div>';
            const outlets = await getOutlets(stationId);
            if (!outlets || outlets.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-sm text-gray-500 py-4">该充电站暂无插座信息。</p>`;
                cardElement.querySelector('.total-outlets').textContent = 0;
                cardElement.querySelector('.available-outlets').textContent = 0;
                cardElement.querySelector('.occupied-outlets').textContent = 0;
                return;
            }
            const statuses = await Promise.all(outlets.map(o => getOutletStatus(o.outletNo)));
            const outletsHTML = outlets
                .sort((a, b) => a.outletSerialNo - b.outletSerialNo)
                .map((outlet, i) => buildOutletCardHTML(statuses[i]))
                .join('');
            container.innerHTML = outletsHTML;
            let availableCount = statuses.filter(s => s?.outlet?.iCurrentChargingRecordId === 0).length;
            cardElement.querySelector('.total-outlets').textContent = outlets.length;
            cardElement.querySelector('.available-outlets').textContent = availableCount;
            cardElement.querySelector('.occupied-outlets').textContent = outlets.length - availableCount;
        }
        
        async function renderFavoritesPage() {
            const container = document.getElementById('favorites-container');
            container.innerHTML = '<div class="flex justify-center p-8"><div class="loader"></div></div>'; 
            const favoriteIds = FavoritesManager.get();
            const allStations = StationDB.get() || [];
            if (favoriteIds.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 mt-8">您还没有收藏任何充电桩。</p>';
                return;
            }
            const favorites = favoriteIds.map(id => allStations.find(s => s.stationId === id)).filter(Boolean);
            container.innerHTML = '';
            favorites.forEach(station => {
                const stationCardEl = document.getElementById('station-card-template').content.cloneNode(true);
                const stationCard = stationCardEl.querySelector('.station-card');
                stationCard.dataset.stationId = station.stationId;
                stationCard.querySelector('.station-name').textContent = station.stationName;
                stationCard.querySelector('.station-address').textContent = station.address;
                stationCard.querySelector('.remove-favorite-btn').onclick = () => {
                    FavoritesManager.remove(station.stationId);
                    renderFavoritesPage();
                };
                container.appendChild(stationCardEl);
                updateFavoriteStationCard(station.stationId, stationCard);
            });
        }
        
        function getColorForAvailability(ratio) { if (ratio < 0 || isNaN(ratio)) return '#9ca3af'; if (ratio === 0) return '#b91c1c'; const hue = ratio * 120; const lightness = 45 + (ratio * 15); const saturation = 75 + (ratio * 20); return `hsl(${hue}, ${saturation}%, ${lightness}%)`; }
        function showError(message) { errorMessage.textContent = message; errorOverlay.classList.remove('hidden'); }

        initApp();
    });
    </script>

    <script>
        var t = setInterval(function() {
            if (window.goatcounter && window.goatcounter.visit_count) {
                clearInterval(t);
                window.goatcounter.visit_count({
                    append: '#visitor-stats',
                    path: 'TOTAL',
                    type: 'html'
                });
            }
        }, 100);
    </script>
    <script data-goatcounter="https://mumiao.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>